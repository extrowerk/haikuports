From a3fb803a57f327d8c04a75235f50bd767ab41fa6 Mon Sep 17 00:00:00 2001
From: Nobuyoshi Nakada <nobu@ruby-lang.org>
Date: Tue, 15 Dec 2020 23:17:23 +0200
Subject: Ignore failure on unsupported fcntl to drop non-blocking mode


diff --git a/ruby.c b/ruby.c
index 96d8f75..35f77dd 100644
--- a/ruby.c
+++ b/ruby.c
@@ -2136,9 +2136,13 @@ open_load_file(VALUE fname_v, int *xflag)
 	rb_update_max_fd(fd);
 
 #if defined HAVE_FCNTL && MODE_TO_LOAD != O_RDONLY
+# ifdef ENOTSUP
+#   define IS_SUPPORTED_OP(e) ((e) != ENOTSUP)
+# else
+#   define IS_SUPPORTED_OP(e) ((void)(e), 1)
+# endif
 	/* disabling O_NONBLOCK */
-	if (fcntl(fd, F_SETFL, 0) < 0) {
-	    e = errno;
+	if (fcntl(fd, F_SETFL, 0) < 0 && IS_SUPPORTED_OP(e = errno)) {
 	    (void)close(fd);
 	    rb_load_fail(fname_v, strerror(e));
 	}
-- 
2.28.0


From 33ec752f4c12a5f3cd1eeb17be899bed64564470 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zolt=C3=A1n=20Mizsei?= <zmizsei@extrowerk.com>
Date: Sun, 5 May 2019 15:35:20 +0200
Subject: Test fix for Haiku


diff --git a/test/fiddle/helper.rb b/test/fiddle/helper.rb
index 73f6f78..ba51c22 100644
--- a/test/fiddle/helper.rb
+++ b/test/fiddle/helper.rb
@@ -99,6 +99,18 @@ when /aix/
       end
     end
   end
+when /haiku/
+  libdir = '/system/lib'
+  case [0].pack('L!').size
+  when 4
+    # 32-bit ruby
+    libdir = '/system/lib/x86' if File.directory? '/system/lib/x86'
+  when 8
+    # 64-bit ruby
+    libdir = '/system/lib/' if File.directory? '/system/lib/'
+  end
+  libc_so = File.join(libdir, "libroot.so")
+  libm_so = File.join(libdir, "libroot.so")
 else
   libc_so = ARGV[0] if ARGV[0] && ARGV[0][0] == ?/
   libm_so = ARGV[1] if ARGV[1] && ARGV[1][0] == ?/
-- 
2.28.0


From 075c64842168cfb5535a1b04b6d729bfeb7fab75 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zolt=C3=A1n=20Mizsei?= <zmizsei@extrowerk.com>
Date: Wed, 25 Dec 2019 19:53:24 +0100
Subject: Add Haiku to the context support list


diff --git a/configure.ac b/configure.ac
index 6766df2..ca10de2 100644
--- a/configure.ac
+++ b/configure.ac
@@ -2346,6 +2346,9 @@ AS_CASE([$rb_cv_coroutine], [yes|''], [
         [*-openbsd*], [
             rb_cv_coroutine=copy
         ],
+        [*-haiku*], [
+            rb_cv_coroutine=copy
+        ],
         [*], [
             rb_cv_coroutine=ucontext
         ]
-- 
2.28.0


From b09b9c88d2fa107a5927d90b616fb944d1006fe7 Mon Sep 17 00:00:00 2001
From: Gerasim Troeglazov <3dEyes@gmail.com>
Date: Mon, 8 Jun 2020 19:42:51 +1000
Subject: Disable stack-protector


diff --git a/configure.ac b/configure.ac
index ca10de2..b13de6c 100644
--- a/configure.ac
+++ b/configure.ac
@@ -587,7 +587,7 @@ AS_IF([test "$GCC" = yes], [
 
     # -fstack-protector
     AS_CASE(["$target_os"],
-    [mingw*], [
+    [mingw*|haiku*], [
 	stack_protector=no
     ])
     AS_IF([test -z "${stack_protector+set}"], [
-- 
2.28.0

