SUMMARY="UNIX-like reverse engineering framework and commandline tools"
DESCRIPTION="Forensics tool, scriptable commandline hexadecimal editor, \
able to open disk files, analyzing binaries in several common and less common \
formats, disassemble code for several CPU architectures, debug programs, attach \
to remote GDB servers, and much more."
HOMEPAGE="https://radare.org/"
COPYRIGHT="2009-2018 nibble, pancake"
LICENSE="GNU GPL v3
	GNU LGPL v3"
REVISION="1"
SOURCE_URI="https://github.com/radare/radare2/archive/$portVersion.tar.gz"
CHECKSUM_SHA256="e2edef4d70c7bbbb47d04002ce9d384eb2fc9c0cd4cbfde77cda8c10cae9ff24"
PATCHES="radare2-$portVersion.patchset"

ARCHITECTURES="?x86_gcc2 x86 x86_64"
SECONDARY_ARCHITECTURES="x86"

commandBinDir=$binDir
commandSuffix=$secondaryArchSuffix
if [ "$targetArchitecture" = x86_gcc2 ]; then
	commandBinDir=$prefix/bin
	commandSuffix=
fi

libVersion="$portVersion"
libVersionCompat="$libVersion compat >= ${libVersion%%.*}"

PROVIDES="
	radare2$secondaryArchSuffix = $portVersion
	cmd:r2$commandSuffix
	cmd:r2agent$commandSuffix
	cmd:r2pm$commandSuffix
	cmd:rabin2$commandSuffix
	cmd:radare2$commandSuffix
	cmd:radiff2$commandSuffix
	cmd:rafind2$commandSuffix
	cmd:ragg2$commandSuffix
	cmd:ragg2_cc$commandSuffix
	cmd:rahash2$commandSuffix
	cmd:rarun2$commandSuffix
	cmd:rasm2$commandSuffix
	cmd:rax2$commandSuffix
	lib:libr2$secondaryArchSuffix = $libVersion
	lib:libr_anal$secondaryArchSuffix
	lib:libr_asm$secondaryArchSuffix
	lib:libr_bin$secondaryArchSuffix
	lib:libr_bp$secondaryArchSuffix
	lib:libr_config$secondaryArchSuffix
	lib:libr_cons$secondaryArchSuffix
	lib:libr_core$secondaryArchSuffix
	lib:libr_crypto$secondaryArchSuffix
	lib:libr_debug$secondaryArchSuffix
	lib:libr_egg$secondaryArchSuffix
	lib:libr_flag$secondaryArchSuffix
	lib:libr_fs$secondaryArchSuffix
	lib:libr_hash$secondaryArchSuffix
	lib:libr_io$secondaryArchSuffix
	lib:libr_lang$secondaryArchSuffix
	lib:libr_magic$secondaryArchSuffix
	lib:libr_parse$secondaryArchSuffix
	lib:libr_reg$secondaryArchSuffix
	lib:libr_search$secondaryArchSuffix
	lib:libr_shlr$secondaryArchSuffix = $libVersion
	lib:libr_socket$secondaryArchSuffix
	lib:libr_syscall$secondaryArchSuffix
	lib:libr_util$secondaryArchSuffix
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libcapstone$secondaryArchSuffix
	lib:libcrypto$secondaryArchSuffix
	lib:libmagic$secondaryArchSuffix
	lib:libssl$secondaryArchSuffix
	"

PROVIDES_devel="
	radare2${secondaryArchSuffix}_devel = $portVersion
	devel:libr2$secondaryArchSuffix = $libVersion
	devel:libr_shlr$secondaryArchSuffix = $libVersion
	"
REQUIRES_devel="
	radare2${secondaryArchSuffix} == $portVersion base
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libcapstone$secondaryArchSuffix
	devel:libcrypto$secondaryArchSuffix
	devel:liblua$secondaryArchSuffix
	devel:libmagic$secondaryArchSuffix
	devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:awk
	cmd:find
	cmd:gcc$secondaryArchSuffix
	cmd:git
	cmd:make
	cmd:sh
	cmd:patch
	cmd:pkg_config$secondaryArchSuffix
	"

# What happend with libr2.so?
defineDebugInfoPackage radare2$secondaryArchSuffix \
	"$commandBinDir"/r2agent \
	"$commandBinDir"/rabin2 \
	"$commandBinDir"/radare2 \
	"$commandBinDir"/radiff2 \
	"$commandBinDir"/rafind2 \
	"$commandBinDir"/ragg2 \
	"$commandBinDir"/rahash2 \
	"$commandBinDir"/rarun2 \
	"$commandBinDir"/rasm2 \
	"$commandBinDir"/rax2 \
	"$libDir"/libr_anal.so.$portVersion \
	"$libDir"/libr_asm.so.$portVersion \
	"$libDir"/libr_bin.so.$portVersion \
	"$libDir"/libr_bp.so.$portVersion \
	"$libDir"/libr_config.so.$portVersion \
	"$libDir"/libr_cons.so.$portVersion \
	"$libDir"/libr_core.so.$portVersion \
	"$libDir"/libr_crypto.so.$portVersion \
	"$libDir"/libr_debug.so.$portVersion \
	"$libDir"/libr_egg.so.$portVersion \
	"$libDir"/libr_flag.so.$portVersion \
	"$libDir"/libr_fs.so.$portVersion \
	"$libDir"/libr_hash.so.$portVersion \
	"$libDir"/libr_io.so.$portVersion \
	"$libDir"/libr_lang.so.$portVersion \
	"$libDir"/libr_magic.so.$portVersion \
	"$libDir"/libr_parse.so.$portVersion \
	"$libDir"/libr_reg.so.$portVersion \
	"$libDir"/libr_search.so.$portVersion \
	"$libDir"/libr_socket.so.$portVersion \
	"$libDir"/libr_syscall.so.$portVersion \
	"$libDir"/libr_util.so.$portVersion

BUILD()
{
	runConfigure --omit-dirs docdir,datarootdir,bindir ./configure \
		--bindir=$commandBinDir \
		--with-sysmagic \
		--with-syscapstone \
		--with-openssl
	make $jobArgs
}

INSTALL()
{
	make install
	cp libr/*/libr_*.so $libDir

	mkdir -p `dirname $docDir`
	mv $prefix/data/radare2 $docDir
	rm -rf $prefix/share

	prepareInstalledDevelLibs libr2 libr_shlr

	fixPkgconfig

	packageEntries devel \
		$developDir
}
