SUMMARY="Open Source remake of The Settlers II game"
DESCRIPTION="Return To The Roots is a fan-project, which aims to renew the \
original The Settlers 2."
HOMEPAGE="https://www.siedler25.org/"
COPYRIGHT="2005-2019 Settlers Freaks"
LICENSE="GNU GPL v3"
REVISION="1"

srcGitRev="90d4fe80cff72e57b7e604ba6eefb85a7985f97c"
srcGitRev_2="ea7b0ad568a74b4405de978a413104bf9cb3364e"
srcGitRev_3="a6980e7077955b7b6b8fb8fbca456e29a97d64b2"
srcGitRev_4="efb7656bea5725ec196cfb1a5b5bb79ac93b8dea"
srcGitRev_5="851d89aa04c7efbcb45f01c60938d0fd2874e1df"
srcGitRev_6="19e8cdd32f2d2fc89bdafa69f4da788d448f8429"
srcGitRev_7="735b9ceddd4f795dc26c8fe277c7bca2671463a0"
srcGitRev_8="b7728d14ddc5a279697ecb9d42babd006f2a8ed4"
srcGitRev_9="79fec8edaa7e7375ee75889a984c8af5d3fd5c36"
srcGitRev_10="38ca7e1d894c138e454bbe5c89048bdd5091545a"
srcGitRev_11="b1978170473bbf39a24254814e1b1f967a51ef4c"
srcGitRev_12="5c0f29012511339ba5cc2672f99a1356c5387b62"

SOURCE_URI="https://github.com/Return-To-The-Roots/s25client/archive/$srcGitRev.tar.gz"
SOURCE_URI_2="https://github.com/Return-To-The-Roots/libendian/archive/$srcGitRev_2.tar.gz"
SOURCE_URI_3="https://github.com/Return-To-The-Roots/liblobby/archive/$srcGitRev_3.tar.gz"
SOURCE_URI_4="https://github.com/Return-To-The-Roots/libsiedler2/archive/$srcGitRev_4.tar.gz"
SOURCE_URI_5="https://github.com/Return-To-The-Roots/libutil/archive/$srcGitRev_5.tar.gz"
SOURCE_URI_6="https://github.com/Return-To-The-Roots/mygettext/archive/$srcGitRev_6.tar.gz"
SOURCE_URI_7="https://github.com/Return-To-The-Roots/s-c/archive/$srcGitRev_7.tar.gz"
SOURCE_URI_8="https://github.com/Return-To-The-Roots/s25edit/archive/$srcGitRev_8.tar.gz"
SOURCE_URI_9="https://github.com/Return-To-The-Roots/s25update/archive/$srcGitRev_9.tar.gz"
SOURCE_URI_10="https://github.com/satoren/kaguya/archive/$srcGitRev_10.tar.gz"
SOURCE_URI_11="https://github.com/Return-To-The-Roots/languages/archive/$srcGitRev_11.tar.gz"
SOURCE_URI_12="https://github.com/Return-To-The-Roots/turtle/archive/$srcGitRev_12.tar.gz"

CHECKSUM_SHA256="56f216fc442c80c9c26099a35c856905700da709b9f54fdafceadce3e758aa52"
CHECKSUM_SHA256_2="fd43f1c3ace174a699e9f48ad9191a777fe76cbb8f547e8ade664fc2b8c6f432"
CHECKSUM_SHA256_3="6a608f73c08f5d5120c2749234a0d608d4d753ce1531b610b56a7ad0057809f0"
CHECKSUM_SHA256_4="bf03f6c0db5d996e972e238c5e0aff811f987258b206355d9b18e1f7259d1d03"
CHECKSUM_SHA256_5="53c8daa6fac661cee693b504c507d3594f204fa330af5994ec3fe40098cee306"
CHECKSUM_SHA256_6="b4479ff76258f96890d1e48a04563d821885c43cedadca09bb8f0eb89f548bab"
CHECKSUM_SHA256_7="c14e63961d1696acc9e2231f617344930092fddbc322eec0a88161d13e4d5d87"
CHECKSUM_SHA256_8="92011ce6fa84f2aec5d85fe480b989c4736ee033693cd4ca8f9619ca408fe46e"
CHECKSUM_SHA256_9="45327f650f6000ef5727eab21540b80f84347d7dd0af54bc41fb60d849094bfa"
CHECKSUM_SHA256_10="23096cbdc3d97f5f513148ce284f5e01397cdb0570089504e66570ed8f1283b6"
CHECKSUM_SHA256_11="4f6565528da00e0659a1fcdcf7be6b4f9864f18434b6b8f0fe2b92c4ce42a833"
CHECKSUM_SHA256_12="7eed73816f3ee895cd1a68fa790b65727772a3dc979eb6b0993755f6cacbf38b"

SOURCE_DIR="s25client-$srcGitRev"
SOURCE_DIR_2="libendian-$srcGitRev_2"
SOURCE_DIR_3="liblobby-$srcGitRev_3"
SOURCE_DIR_4="libsiedler2-$srcGitRev_4"
SOURCE_DIR_5="libutil-$srcGitRev_5"
SOURCE_DIR_6="mygettext-$srcGitRev_6"
SOURCE_DIR_7="s-c-$srcGitRev_7"
SOURCE_DIR_8="s25edit-$srcGitRev_8"
SOURCE_DIR_9="s25update-$srcGitRev_9"
SOURCE_DIR_10="kaguya-$srcGitRev_10"
SOURCE_DIR_11="languages-$srcGitRev_11"
SOURCE_DIR_12="turtle-$srcGitRev_12"

SOURCE_FILENAME="s25client-$srcGitRev.tar.gz"
SOURCE_FILENAME_2="libendian-$srcGitRev_2.tar.gz"
SOURCE_FILENAME_3="liblobby-$srcGitRev_3.tar.gz"
SOURCE_FILENAME_4="libsiedler2-$srcGitRev_4.tar.gz"
SOURCE_FILENAME_5="libutil-$srcGitRev_5.tar.gz"
SOURCE_FILENAME_6="mygettext-$srcGitRev_6.tar.gz"
SOURCE_FILENAME_7="s-c-$srcGitRev_7.tar.gz"
SOURCE_FILENAME_8="s25edit-$srcGitRev_8.tar.gz"
SOURCE_FILENAME_9="s25update-$srcGitRev_9.tar.gz"
SOURCE_FILENAME_10="kaguya-$srcGitRev_10.tar.gz"
SOURCE_FILENAME_11="languages-$srcGitRev_11.tar.gz"
SOURCE_FILENAME_12="turtle-$srcGitRev_12.tar.gz"

PATCHES="s25rttr-$portVersion.patchset"
PATCHES_5="s25rttr-$portVersion-source5.patchset"
PATCHES_7="s25rttr-$portVersion-source7.patchset"

ARCHITECTURES="?x86_gcc2 ?x86 x86_64"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	s25rttr$secondaryArchSuffix = $portVersion
	app:s25client = $portVersion
	app:s25edit = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libboost_chrono$secondaryArchSuffix >=1.64.0
	lib:libboost_filesystem$secondaryArchSuffix >=1.64.0
	lib:libboost_iostreams$secondaryArchSuffix >=1.64.0
	lib:libboost_locale$secondaryArchSuffix >=1.64.0
	lib:libboost_program_options$secondaryArchSuffix >=1.64.0
	lib:libboost_random$secondaryArchSuffix >=1.64.0
	lib:libboost_regex$secondaryArchSuffix >=1.64.0
	lib:libboost_system$secondaryArchSuffix >=1.64.0
	lib:libbz2$secondaryArchSuffix
	lib:libcurl$secondaryArchSuffix
	lib:libexecinfo$secondaryArchSuffix
	lib:libGL$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:liblua$secondaryArchSuffix >= 5.2
	lib:libminiupnpc$secondaryArchSuffix
	lib:libSDL_1.2$secondaryArchSuffix
	lib:libSDL_mixer_1.2$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libSDL2_mixer_2.0$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libboost_chrono$secondaryArchSuffix >=1.64.0
	devel:libboost_filesystem$secondaryArchSuffix >=1.64.0
	devel:libboost_iostreams$secondaryArchSuffix >=1.64.0
	devel:libboost_locale$secondaryArchSuffix >=1.64.0
	devel:libboost_program_options$secondaryArchSuffix >=1.64.0
	devel:libboost_random$secondaryArchSuffix >=1.64.0
	devel:libboost_regex$secondaryArchSuffix >=1.64.0
	devel:libboost_system$secondaryArchSuffix >=1.64.0
	devel:libbz2$secondaryArchSuffix
	devel:libcurl$secondaryArchSuffix
	devel:libexecinfo$secondaryArchSuffix
	devel:libGL$secondaryArchSuffix
	devel:libiconv$secondaryArchSuffix
	devel:liblua$secondaryArchSuffix >= 5.2
	devel:libminiupnpc$secondaryArchSuffix
	devel:libSDL_1.2$secondaryArchSuffix
	devel:libSDL_mixer_1.2$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libSDL2_mixer$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:awk
	cmd:cmake
	cmd:gcc$secondaryArchSuffix
	cmd:gettext
	cmd:libtoolize$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

defineDebugInfoPackage s25rttr$secondaryArchSuffix \
	"$appsDir"/RTTR/s25client \
	"$appsDir"/RTTR/s25edit

BUILD()
{
	# remove empty folders
	cd external
	rm -rf libendian liblobby libsiedler2 libutil mygettext \
		s-c s25edit s25update kaguya languages turtle
	# link submodules
	ln -sfn $sourceDir2 libendian
	ln -sfn $sourceDir3 liblobby
	ln -sfn $sourceDir4 libsiedler2
	ln -sfn $sourceDir5 libutil
	ln -sfn $sourceDir6 mygettext
	ln -sfn $sourceDir7 s-c
	ln -sfn $sourceDir8 s25edit
	ln -sfn $sourceDir9 s25update
	ln -sfn $sourceDir10 kaguya
	ln -sfn $sourceDir11 languages
	ln -sfn $sourceDir12 turtle
	cd ..

	mkdir -p haiku_build && cd haiku_build

	#OGL values: OGL2.0Compat;OGL2.0;OGL2.1Compat;OGL2.1;OGL3.3;GLES2.0
	cmake .. \
		-DCMAKE_BUILD_TYPE=Release \
		-DBUILD_TESTING=OFF \
		-DCMAKE_INSTALL_PREFIX="$appsDir/RTTR" \
		-DCMAKE_INSTALL_BINDIR="$appsDir/RTTR" \
		-DCMAKE_INSTALL_DOCDIR="$docDir" \
		-DRTTR_DOCDIR="$docDir" \
		-DCMAKE_INSTALL_DATADIR="$dataDir" \
		-DRTTR_DATADIR="s25rttr" \
		-DRTTR_GAMEDIR="`finddir B_USER_NONPACKAGED_DATA_DIRECTORY`/s25rttr/S2" \
		-DRTTR_OPENGL="OGL2.0Compat" \
		-DCMAKE_CXX_FLAGS="-DBOOST_NO_CXX14_CONSTEXPR"

	make $jobArgs
}

INSTALL()
{
	cd haiku_build
	make install

	# Bugfix, SDL based vo have problems creating the OGL context
	# Fallback to SDL2. Audio still uses SDL.
	rm -rf "$appsDir"/RTTR/lib/driver/video/libvideoSDL.so

	addAppDeskbarSymlink "$appsDir"/RTTR/s25client
	addAppDeskbarSymlink "$appsDir"/RTTR/s25edit
}

TEST()
{
	cd haiku_build
	make test
}
