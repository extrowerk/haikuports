#!/bin/sh
# To be able to use this shortcut, the main binary should be symlinked as mame.
mame="`finddir B_SYSTEM_BIN_DIRECTORY`"/mame

mame_first_run() {
  echo "Creating an ini file for MAME at ${SETTINGS_FOLDER}/mame.ini"
  echo "Modify this file for permanent changes to your MAME"
  echo "options and paths before running MAME again."

  cd -- "@SETTINGS_FOLDER@" || exit

  if [ -e mame.ini ]; then
    mv mame.ini mameini.bak || exit
    echo "Your old ini file has been renamed to mameini.bak"
  fi

  # Note: the single quotes here are not a mistake; MAME will save these
  # strings verbatim into its configuration file, and expand the variables when
  # it is run in future.
  "$mame" \
    -artpath '@SETTINGS_FOLDER@
/artwork;@VENDOR_FOLDER@/artwork' \
    -bgfx_path '@SETTINGS_FOLDER@
/bgfx;@VENDOR_FOLDER@/bgfx' \
    -ctrlrpath '@SETTINGS_FOLDER@
/ctrlr;@VENDOR_FOLDER@/ctrlr' \
    -hashpath '@SETTINGS_FOLDER@
/hash;@VENDOR_FOLDER@/hash' \
    -languagepath '@SETTINGS_FOLDER@
/language;@VENDOR_FOLDER@/language' \
    -pluginspath '@VENDOR_FOLDER@/plugins' \
    -inipath '@SETTINGS_FOLDER@
/ini' \
    -rompath '@SETTINGS_FOLDER@
/roms' \
    -samplepath '@SETTINGS_FOLDER@
/samples' \
    -cfg_directory '@SETTINGS_FOLDER@
/cfg' \
    -comment_directory '@SETTINGS_FOLDER@
/comments' \
    -diff_directory '@SETTINGS_FOLDER@
/diff' \
    -input_directory '@SETTINGS_FOLDER@
/inp' \
    -nvram_directory '@SETTINGS_FOLDER@
/nvram' \
    -snapshot_directory '@SETTINGS_FOLDER@
/snap' \
    -state_directory '@SETTINGS_FOLDER@
/sta' \
    -video opengl \
    -createconfig
}

if [ "$1" = "--newini" ]; then
  mame_first_run
  exit
elif ! [ -e "@SETTINGS_FOLDER@
" ]; then
  echo "Running MAME for the first time..."

  mkdir -- "@SETTINGS_FOLDER@
"
  (
    cd -- "@SETTINGS_FOLDER@
" || exit
    mkdir artwork bgfx cfg comments ctrlr diff hash ini inp language nvram samples snap sta roms

    mame_first_run
  ) || exit
fi

exec "$mame" "$@"
