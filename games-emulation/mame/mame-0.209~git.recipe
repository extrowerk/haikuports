SUMMARY="A a multi-purpose emulation framework"
DESCRIPTION="MAME\'s purpose is to preserve decades of software history. As \
electronic technology continues to rush forward, MAME prevents this important \
\"vintage\" software from being lost and forgotten. This is achieved by \
documenting the hardware and how it functions. The source code to MAME \
serves as this documentation. The fact that the software is usable serves \
primarily to validate the accuracy of the documentation (how else can you \
prove that you have recreated the hardware faithfully?). Over time, MAME \
(originally stood for Multiple Arcade Machine Emulator) absorbed the \
sister-project MESS (Multi Emulator Super System), so MAME now documents a \
wide variety of (mostly vintage) computers, video game consoles and \
calculators, in addition to the arcade video games that were its initial focus."
HOMEPAGE="https://www.mamedev.org/"
COPYRIGHT="1997-2019 MAMEDev and contributors"
LICENSE="GNU GPL v2"
REVISION="1"
srcGitRev="dcf6e1c61be02811aa2205c46a2e006331b3f14d"
SOURCE_URI="https://github.com/mamedev/mame/archive/$srcGitRev.zip"
CHECKSUM_SHA256="9681d79dae311cdab3de91bc21a030cc030511d96fb643aacd4ad404e42896ce"
SOURCE_FILENAME="mame-$srcGitRev.zip"
SOURCE_DIR="mame-$srcGitRev"
PATCHES="mame-$portVersion.patchset"
ADDITIONAL_FILES="
	mame.sh.in
	mame.rdef.in
	"

ARCHITECTURES="!x86_gcc2 x86 x86_64"
SECONDARY_ARCHITECTURES="x86"

bits=64
commandBinDir=$binDir
commandSuffix=$secondaryArchSuffix
if [ "$targetArchitecture" = x86_gcc2 ]
then
	bits=""
	commandBinDir=$prefix/bin
	commandSuffix=
fi

PROVIDES="
	mame$secondaryArchSuffix = $portVersion
	cmd:castool$commandSuffix
	cmd:chdman$commandSuffix
	cmd:floptool$commandSuffix
	cmd:imgtool$commandSuffix
	cmd:jedutil$commandSuffix
	cmd:ldresample$commandSuffix
	cmd:ldverify$commandSuffix
	cmd:mame$commandSuffix
	cmd:mame$bits$commandSuffix
	cmd:mame.sh
	cmd:nltool$commandSuffix
	cmd:nlwav$commandSuffix
	cmd:pngcmp$commandSuffix
	cmd:regrep$commandSuffix
	cmd:romcmp$commandSuffix
	cmd:split$commandSuffix
	cmd:src2html$commandSuffix
	cmd:srcclean$commandSuffix
	cmd:testkeys$commandSuffix
	cmd:unidasm$commandSuffix
"

REQUIRES="
	haiku$secondaryArchSuffix
	glm$secondaryArchSuffix
	lib:libexpat$secondaryArchSuffix
	lib:libflac$secondaryArchSuffix
	lib:libfontconfig$secondaryArchSuffix
	lib:libfreetype$secondaryArchSuffix
	lib:libGL$secondaryArchSuffix
	lib:libjpeg$secondaryArchSuffix
	lib:liblua$secondaryArchSuffix
	lib:libpugixml$secondaryArchSuffix
	lib:libQt5Core$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
	lib:libSDL2_ttf$secondaryArchSuffix
	lib:libsqlite3$secondaryArchSuffix
	lib:libutf8proc$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	glm${secondaryArchSuffix}_devel
	devel:libexpat$secondaryArchSuffix
	devel:libflac$secondaryArchSuffix
	devel:libfontconfig$secondaryArchSuffix
	devel:libfreetype$secondaryArchSuffix
	devel:libGL$secondaryArchSuffix
	devel:libjpeg$secondaryArchSuffix
	devel:liblua$secondaryArchSuffix
	devel:libpugixml$secondaryArchSuffix
	devel:libQt5Core$secondaryArchSuffix
	devel:librapidjson$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
	devel:libSDL2_ttf$secondaryArchSuffix
	devel:libsqlite3$secondaryArchSuffix
	devel:libutf8proc$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
"
BUILD_PREREQUIRES="
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:libtoolize
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	cmd:python2
	cmd:sed
	cmd:strip$secondaryArchSuffix
"

BUILD()
{
	LIBS="-lbsd -lnetwork -lpugixml -lsqlite3" \
	LDFLAGS="-lbsd -lnetwork -lpugixml -lsqlite3"	\
	make	\		
		REGENIE=1 \
		TOOLS=1 \
		PRECOMPILE=0 \
		USE_SYSTEM_LIB_EXPAT=1 \
		USE_SYSTEM_LIB_ZLIB=1 \
		USE_SYSTEM_LIB_JPEG=1 \
		USE_SYSTEM_LIB_FLAC=1 \
		USE_SYSTEM_LIB_LUA=1 \
		USE_SYSTEM_LIB_SQLITE3=1 \
		USE_BUNDLED_LIB_SDL2=1 \
		USE_SYSTEM_LIB_UTF8PROC=1 \
		USE_SYSTEM_LIB_GLM=1 \
		USE_SYSTEM_LIB_RAPIDJSON=1 \
		USE_SYSTEM_LIB_PUGIXML=1 \
		NOWERROR=1 \
		OPTIMIZE=2 \
		$jobArgs
}

INSTALL()
{
	# Based on https://projects.archlinux.de/svntogit/community.git/tree/trunk/PKGBUILD?h=packages/mame
	# If you change any path here, you wil lhave to adjust it in mame.sh.in too!

	# Arch cleanup
	# 32 bit main binary called as "mame" which would collide with our symlink
	if [ "$targetArchitecture" = x86_gcc2 ]
	then
		cp mame mame$bits
	fi

	# Install the binaries
	mkdir -p $commandBinDir
	for _i in castool chdman floptool imgtool jedutil ldresample ldverify \
	mame$bits nltool nlwav pngcmp regrep romcmp split src2html srcclean \
	testkeys unidasm; do
		install -m755 $_i -t "$commandBinDir"
		strip "$commandBinDir"/$_i
	done
	ln -s "$commandBinDir/mame$bits" "$commandBinDir/mame"

	# Create startscript
	local SETTINGS_FOLDER="`finddir B_USER_SETTINGS_DIRECTORY`/mame"
	local VENDOR_FOLDER="`finddir B_SYSTEM_LIB_DIRECTORY`/mame"
	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		$portDir/additional-files/mame.sh.in > "$commandBinDir"/mame.sh
	chmod +x "$commandBinDir"/mame.sh

	# Add extra attributes
	local APP_SIGNATURE="application/x-vnd.mame"
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
#	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2 | cut -d~ -f1`" # ~git
#	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	local MINOR="0" # ~git
	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@SUMMARY@|$SUMMARY|" \
		-e "s|@DESCRIPTION@|$DESCRIPTION|" \
		$portDir/additional-files/mame.rdef.in > mame.rdef

	addResourcesToBinaries mame.rdef \
		"$commandBinDir/mame$bits"

	rc mame.rdef
	resattr -o "$commandBinDir"/mame.sh \
		mame.rsrc

	addAppDeskbarSymlink "$commandBinDir"/mame.sh "MAME"

	# Install the extra bits
	install -Dm644 src/osd/modules/opengl/shader/glsl*.*h -t "$libDir"/mame/shader/
	cp -ar {artwork,bgfx,plugins,language,ctrlr,keymaps,hash} "$libDir"/mame/

	# FS#28203
	sed -i 's|KEYCODE_2_PAD|KEYCODE_2PAD|' "$libDir"/mame/ctrlr/*.cfg
	sed -i 's|KEYCODE_4_PAD|KEYCODE_4PAD|' "$libDir"/mame/ctrlr/*.cfg
	sed -i 's|KEYCODE_6_PAD|KEYCODE_6PAD|' "$libDir"/mame/ctrlr/*.cfg
	sed -i 's|KEYCODE_8_PAD|KEYCODE_8PAD|' "$libDir"/mame/ctrlr/*.cfg

	# documentation
	install -dm0755 "$manDir"/man{1,6}
	install -m644 docs/man/*.1* "$manDir"/man1
	install -m644 docs/man/*.6* "$manDir"/man6
}
