SUMMARY="Open source continuation of Bungieâ€™s Marathon 2 game engine"
DESCRIPTION="Aleph One plays Marathon, Marathon 2, Marathon Infinity, and \
3rd-party content on a wide array of platforms, with (optional) OpenGL \
rendering, Internet play, Lua scripting, and more."
HOMEPAGE="https://alephone.lhowon.org/"
COPYRIGHT="1991-2001 Bungie Software
	Aleph One Developers"
LICENSE="GNU GPL v3"
REVISION="1"
srcGitRev="b5ac7ae645404e1f23d2dca388373195bcac5504"
SOURCE_URI="https://github.com/Aleph-One-Marathon/alephone/archive/$srcGitRev.tar.gz"
CHECKSUM_SHA256="711eddff5c139cf523ddda4f2f9c6da30a7e52feb668bef8dec041614747f189"
SOURCE_DIR="alephone-$srcGitRev"
SOURCE_URI_2="https://github.com/Aleph-One-Marathon/alephone/releases/download/release-20150620/Marathon-20150620-Data.zip"
SOURCE_DIR_2="Marathon"
CHECKSUM_SHA256_2="774cb40c9bde33a5d23146e82f593ac001edd0ee4d62e5b0445953a95fd44f31"
SOURCE_URI_3="https://github.com/Aleph-One-Marathon/alephone/releases/download/release-20150620/Marathon2-20150620-Data.zip"
SOURCE_DIR_3="Marathon 2"
CHECKSUM_SHA256_3="1b739ea4715892543c151943964038a7634ac20e475a5267db39a23f6603efbe"
SOURCE_URI_4="https://github.com/Aleph-One-Marathon/alephone/releases/download/release-20150620/MarathonInfinity-20150620-Data.zip"
SOURCE_DIR_4="Marathon Infinity"
CHECKSUM_SHA256_4="c4e001a430d021d10d7d2f8ebfea87efb73c5505af95102e60e95a752f54ee69"
PATCHES="alephone-$portVersion.patchset"
ADDITIONAL_FILES="alephone.rdef.in
	startscript.sh.in"

ARCHITECTURES="?x86_gcc2 ?x86 x86_64"
SECONDARY_ARCHITECTURES="x86"

PROVIDES="
	alephone$secondaryArchSuffix = $portVersion
	cmd:alephone$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	lib:libavcodec$secondaryArchSuffix
	lib:libavformat$secondaryArchSuffix
	lib:libavutil$secondaryArchSuffix
	lib:libboost_filesystem$secondaryArchSuffix
	lib:libboost_system$secondaryArchSuffix
	lib:libcurl$secondaryArchSuffix
	lib:libexpat$secondaryArchSuffix
	lib:libGL$secondaryArchSuffix
	lib:libGLU$secondaryArchSuffix
	lib:libmad$secondaryArchSuffix
	lib:libpng16$secondaryArchSuffix
	lib:libSDL2_image_2.0$secondaryArchSuffix
	lib:libSDL2_net_2.0$secondaryArchSuffix
	lib:libSDL2_ttf_2.0$secondaryArchSuffix
	lib:libSDL2_2.0$secondaryArchSuffix
#	lib:libsmpeg$secondaryArchSuffix
	lib:libsndfile$secondaryArchSuffix
	lib:libspeex$secondaryArchSuffix
	lib:libspeexdsp$secondaryArchSuffix
	lib:libswscale$secondaryArchSuffix
	lib:libvorbisfile$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	"

SUMMARY_marathon="Marathon 1 game assets"
DESCRIPTION_marathon="Alien forces have boarded the interstellar colony ship \
Marathon. The situation is dire. As a security officer onboard, it is your \
duty to defend the ship and its crew.

Experience the start of Bungie\'s iconic trilogy with Marathon. This release \
uses the original Marathon data files for the most authentic experience \
outside of a classic Mac or emulator."
PROVIDES_marathon="
	alephone${secondaryArchSuffix}_marathon
	cmd:marathon
	"
REQUIRES_marathon="
	alephone$secondaryArchSuffix
	"

SUMMARY_marathon2="Marathon 2: Durandal game assets"
DESCRIPTION_marathon2="Fresh from your triumph on the starship Marathon, you \
are seized by the rogue computer Durandal to do his bidding in a distant part \
of the galaxy. Within the ruins of an ancient civilization, you must seek \
the remnants of a lost clan and uncover their long-buried secrets. Battle \
opponents ancient and terrible, with sophisticated weapons and devious \
strategies, all the while struggling to escape the alien nightmare...

This release of Marathon 2: Durandal includes the classic graphics, and \
revamped high-definition textures and monsters from the Xbox Live Arcade \
edition."
PROVIDES_marathon2="
	alephone${secondaryArchSuffix}_marathon
	cmd:marathon_2
	"
REQUIRES_marathon="
	alephone$secondaryArchSuffix
	"

SUMMARY_marathon_infinity="Marathon Infinity game assets"
DESCRIPTION_marathon="Marathon Infinity takes the closed universe of the \
Marathon series and blows it wide open. The solo/co-op campaign, \"Blood \
Tides of Lh\'owon\" is a 20-level scenario sporting new textures, weapons, \
and aliens. More than that, the scenario sheds a surprising new light on \
the story\'s characters and the meaning of events. Having defeated the Pfhor \
and reawakened the ancient remnants of the S\'pht, the player now faces a \
world where friends become enemies and all is not what it seems...

Marathon Infinity is the most popular Marathon game in online play, and \
is compatible with hundreds of community-made maps. This release includes \
the classic graphics, and revamped high-definition textures and weapons."
PROVIDES_marathon_infinity="
	alephone${secondaryArchSuffix}_marathon
	cmd:marathon_infinity
	"
REQUIRES_marathon_infinity="
	alephone$secondaryArchSuffix
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	devel:libavcodec$secondaryArchSuffix
	devel:libavformat$secondaryArchSuffix
	devel:libavutil$secondaryArchSuffix
	devel:libboost_filesystem$secondaryArchSuffix
	devel:libboost_system$secondaryArchSuffix
	devel:libcurl$secondaryArchSuffix
	devel:libexpat$secondaryArchSuffix
	devel:libGL$secondaryArchSuffix
	devel:libGLU$secondaryArchSuffix
	devel:libmad$secondaryArchSuffix
	devel:libpng16$secondaryArchSuffix
	devel:libSDL2_image_2.0$secondaryArchSuffix
	devel:libSDL2_net_2.0$secondaryArchSuffix
	devel:libSDL2_ttf_2.0$secondaryArchSuffix
	devel:libSDL2_2.0$secondaryArchSuffix
#	devel:libsmpeg$secondaryArchSuffix
	devel:libsndfile$secondaryArchSuffix
	devel:libspeex$secondaryArchSuffix
	devel:libspeexdsp$secondaryArchSuffix
	devel:libswscale$secondaryArchSuffix
	devel:libvorbisfile$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	devel:libzzip$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:aclocal
	cmd:autoconf
	cmd:autoheader
	cmd:automake
	cmd:awk
	cmd:gcc$secondaryArchSuffix
	cmd:install
	cmd:ld$secondaryArchSuffix
	cmd:make
	cmd:pkg_config$secondaryArchSuffix
	"

defineDebugInfoPackage alephone$secondaryArchSuffix \
	"$binDir"/alephone

BUILD()
{
	export LDFLAGS="-lnetwork"

	runConfigure ./autogen.sh \
		--with-boost-libdir=`finddir B_SYSTEM_LIB_DIRECTORY`

	make $jobArgs
}

INSTALL()
{
	make install

	# Add Haiku resources
	local APP_SIGNATURE="application/x-vnd.org.bungie.source.AlephOne"
	local MAJOR="`echo "$portVersion" | cut -d. -f1`"
	local MIDDLE="`echo "$portVersion" | cut -d. -f2`"
	local MINOR="`echo "$portVersion" | cut -d. -f3`"
	local LONG_INFO="$SUMMARY"

	sed \
		-e "s|@APP_SIGNATURE@|$APP_SIGNATURE|" \
		-e "s|@MAJOR@|$MAJOR|" \
		-e "s|@MIDDLE@|$MIDDLE|" \
		-e "s|@MINOR@|$MINOR|" \
		-e "s|@LONG_INFO@|$LONG_INFO|" \
		$portDir/additional-files/alephone.rdef.in \
			> alephone.rdef

	addResourcesToBinaries alephone.rdef "$binDir"/alephone

	# Game Assets
	echo "Copying game data"
	mkdir -p "$dataDir/AlephOne"
	cp -r "$sourceDir2"/../* \
		"$sourceDir3"/../* \
		"$sourceDir4"/../* \
		"$dataDir/AlephOne"

	# Startscripts
	echo "Preparing startscripts"
	rc alephone.rdef

	for f in "$SOURCE_DIR_2" "$SOURCE_DIR_3" "$SOURCE_DIR_4" ; do
		sed \
			-e "s|@DATA_PATH@|$f|" \
			$portDir/additional-files/startscript.sh.in \
				> "$binDir/$f"
		settype -t application/x-vnd.Be-elfexecutable "$binDir/$f"
		resattr -o "$binDir/$f" alephone.rsrc
		chmod +x "$binDir/$f"
	done

	# Hack the system, because provides cannot have whitespaces
	mv "$binDir/$SOURCE_DIR_3" "$binDir/Marathon_2"
	mv "$binDir/$SOURCE_DIR_4" "$binDir/Marathon_Infinity"

	# Deskbar entries
	echo "Generating Deskbar entries"
	addAppDeskbarSymlink "$binDir/Marathon"
	addAppDeskbarSymlink "$binDir/Marathon_2" "Marathon 2"
	addAppDeskbarSymlink "$binDir/Marathon_Infinity" "Marathon Infinity"

	# Gamedata subpackages
	echo "Splitting the subpackages"
	packageEntries "marathon" \
		"$binDir/Marathon" \
		"$dataDir/AlephOne/$SOURCE_DIR_2" \
		"$dataDir/deskbar/menu/Applications/$SOURCE_DIR_2"

	packageEntries "marathon2" \
		"$binDir/Marathon_2" \
		"$dataDir/AlephOne/$SOURCE_DIR_3" \
		"$dataDir/deskbar/menu/Applications/$SOURCE_DIR_3"

	packageEntries "marathon_infinity" \
		"$binDir/Marathon_Infinity" \
		"$dataDir/AlephOne/$SOURCE_DIR_4" \
		"$dataDir/deskbar/menu/Applications/$SOURCE_DIR_4"
}
