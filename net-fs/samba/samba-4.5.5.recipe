SUMMARY="Library bits of the samba network filesystem"
DESCRIPTION="Samba is an free, open source software suite that provides \
seamless file and print services to SMB/CIFS clients. Samba is freely \
available, unlike other SMB/CIFS implementations, and allows for \
interoperability between Linux/Unix servers and Windows-based clients.
Samba can be run on platforms other than Microsoft Windows, for example, \
UNIX, Linux, IBM System 390, OpenVMS, and other operating systems. Samba uses \
the TCP/IP protocol that is installed on the host server. When correctly \
configured, it allows that host to interact with a Microsoft Windows client \
or server as if it were a Windows file and print server."
HOMEPAGE="http://www.samba.org/"
COPYRIGHT="1992-2017 Anrew Tridgell and the Samba Team"
LICENSE="GNU GPL v3"
REVISION="1"
SOURCE_URI="http://ftp.samba.org/pub/samba/samba-$portVersion.tar.gz"
CHECKSUM_SHA256="bff02762b3e4ee030f02266c6e24a0b888248b387246219b7fbe3e1758ef2184"
PATCHES="samba-4.5.5.patchset"

ARCHITECTURES="x86_gcc2 x86 x86_64"
SECONDARY_ARCHITECTURES="x86_gcc2 x86"
DISABLE_SOURCE_PACKAGE=yes

GLOBAL_WRITABLE_FILES="
	settings/samba directory keep-old
	"

PROVIDES="
	samba$secondaryArchSuffix = $portVersion
	cmd:cifsdd$secondaryArchSuffix = $portVersion
	cmd:dbwrap_tool$secondaryArchSuffix = $portVersion
	cmd:eventlogadm$secondaryArchSuffix = $portVersion
	cmd:findsmb$secondaryArchSuffix = $portVersion
	cmd:gentest$secondaryArchSuffix = $portVersion
	cmd:ldbadd$secondaryArchSuffix = $portVersion
	cmd:ldbdel$secondaryArchSuffix = $portVersion
	cmd:ldbedit$secondaryArchSuffix = $portVersion
	cmd:ldbmodify$secondaryArchSuffix = $portVersion
	cmd:ldbrename$secondaryArchSuffix = $portVersion
	cmd:ldbsearch$secondaryArchSuffix = $portVersion
	cmd:locktest$secondaryArchSuffix = $portVersion
	cmd:masktest$secondaryArchSuffix = $portVersion
	cmd:ndrdump$secondaryArchSuffix = $portVersion
	cmd:net$secondaryArchSuffix = $portVersion
	cmd:nmbd$secondaryArchSuffix = $portVersion
	cmd:nmblookup$secondaryArchSuffix = $portVersion
	cmd:ntlm_auth$secondaryArchSuffix = $portVersion
	cmd:oLschema2ldif$secondaryArchSuffix = $portVersion
	cmd:pdbedit$secondaryArchSuffix = $portVersion
	cmd:pidl$secondaryArchSuffix = $portVersion
	cmd:profiles$secondaryArchSuffix = $portVersion
	cmd:regdiff$secondaryArchSuffix = $portVersion
	cmd:regpatch$secondaryArchSuffix = $portVersion
	cmd:regshell$secondaryArchSuffix = $portVersion
	cmd:regtree$secondaryArchSuffix = $portVersion
	cmd:rpcclient$secondaryArchSuffix = $portVersion
	cmd:samba$secondaryArchSuffix = $portVersion
	cmd:samba_regedit$secondaryArchSuffix = $portVersion
	cmd:samba_tool$secondaryArchSuffix = $portVersion
	cmd:samba_dnsupdate$secondaryArchSuffix = $portVersion
	cmd:samba_kcc$secondaryArchSuffix = $portVersion
	cmd:samba_spnupdate$secondaryArchSuffix = $portVersion
	cmd:samba_upgradedns$secondaryArchSuffix = $portVersion
	cmd:sharesec$secondaryArchSuffix = $portVersion
	cmd:smbcacls$secondaryArchSuffix = $portVersion
	cmd:smbclient$secondaryArchSuffix = $portVersion
	cmd:smbcontrol$secondaryArchSuffix = $portVersion
	cmd:smbcquotas$secondaryArchSuffix = $portVersion
	cmd:smbd$secondaryArchSuffix = $portVersion
	cmd:smbget$secondaryArchSuffix = $portVersion
	cmd:smbpasswd$secondaryArchSuffix = $portVersion
	cmd:smbspool$secondaryArchSuffix = $portVersion
	cmd:smbstatus$secondaryArchSuffix = $portVersion
	cmd:smbtar$secondaryArchSuffix = $portVersion
	cmd:smbtorture$secondaryArchSuffix = $portVersion
	cmd:smbtree$secondaryArchSuffix = $portVersion
	cmd:tdbbackup$secondaryArchSuffix = $portVersion
	cmd:tdbdump$secondaryArchSuffix = $portVersion
	cmd:tdbrestore$secondaryArchSuffix = $portVersion
	cmd:tdbtool$secondaryArchSuffix = $portVersion
	cmd:testparm$secondaryArchSuffix = $portVersion
	cmd:wbinfo$secondaryArchSuffix = $portVersion
	cmd:winbindd$secondaryArchSuffix = $portVersion
	lib:libdcerpc-binding$secondaryArchSuffix = $portVersion
	lib:libdcerpc-samr$secondaryArchSuffix = $portVersion
	lib:libdcerpc-server$secondaryArchSuffix = $portVersion
	lib:libdcerpc$secondaryArchSuffix = $portVersion
	lib:libndr-krb5pac$secondaryArchSuffix = $portVersion
	lib:libndr-nbt$secondaryArchSuffix = $portVersion
	lib:libndr-standard$secondaryArchSuffix = $portVersion
	lib:libndr$secondaryArchSuffix = $portVersion
	lib:libnetapi$secondaryArchSuffix = $portVersion
	lib:libsamba-credentials$secondaryArchSuffix = $portVersion
	lib:libsamba-errors$secondaryArchSuffix = $portVersion
	lib:libsamba-hostconfig$secondaryArchSuffix = $portVersion
	lib:libsamba-passdb$secondaryArchSuffix = $portVersion
	lib:libsamba-policy$secondaryArchSuffix = $portVersion
	lib:libsamba-util$secondaryArchSuffix = $portVersion
	lib:libsamdb$secondaryArchSuffix = $portVersion
	lib:libsmbclient$secondaryArchSuffix = $portVersion
	lib:libsmbconf$secondaryArchSuffix = $portVersion
	lib:libsmbldap$secondaryArchSuffix = $portVersion
	lib:libtevent-util$secondaryArchSuffix = $portVersion
	lib:libwbclient$secondaryArchSuffix = $portVersion
	lib:winbind_krb5_locator$secondaryArchSuffix = $portVersion
	"
REQUIRES="
	haiku$secondaryArchSuffix
	#lib:libcrypto$secondaryArchSuffix
	lib:libexecinfo$secondaryArchSuffix
	lib:libgnutls_openssl$secondaryArchSuffix
	lib:libgpgme$secondaryArchSuffix
	lib:libiconv$secondaryArchSuffix
	lib:libidn$secondaryArchSuffix
	lib:libintl$secondaryArchSuffix
	lib:libldap$secondaryArchSuffix
	lib:libmd$secondaryArchSuffix
	lib:libncurses$secondaryArchSuffix
	lib:libpopt$secondaryArchSuffix
	lib:libreadline$secondaryArchSuffix
	#lib:libssl$secondaryArchSuffix
	lib:libz$secondaryArchSuffix
	lib:libxml2$secondaryArchSuffix
	lib:libexslt$secondaryArchSuffix
	"

PROVIDES_devel="
	samba${secondaryArchSuffix}_devel = $portVersion
	devel:libdcerpc-binding$secondaryArchSuffix = $portVersion
	devel:libdcerpc-samr$secondaryArchSuffix = $portVersion
	devel:libdcerpc-server$secondaryArchSuffix = $portVersion
	devel:libdcerpc$secondaryArchSuffix = $portVersion
	devel:libndr-krb5pac$secondaryArchSuffix = $portVersion
	devel:libndr-nbt$secondaryArchSuffix = $portVersion
	devel:libndr-standard$secondaryArchSuffix = $portVersion
	devel:libndr$secondaryArchSuffix = $portVersion
	devel:libnetapi$secondaryArchSuffix = $portVersion
	devel:libsamba-credentials$secondaryArchSuffix = $portVersion
	devel:libsamba-errors$secondaryArchSuffix = $portVersion
	devel:libsamba-hostconfig$secondaryArchSuffix = $portVersion
	devel:libsamba-passdb$secondaryArchSuffix = $portVersion
	devel:libsamba-policy$secondaryArchSuffix = $portVersion
	devel:libsamba-util$secondaryArchSuffix = $portVersion
	devel:libsamdb$secondaryArchSuffix = $portVersion
	devel:libsmbclient$secondaryArchSuffix = $portVersion
	devel:libsmbconf$secondaryArchSuffix = $portVersion
	devel:libsmbldap$secondaryArchSuffix = $portVersion
	devel:libtevent-util$secondaryArchSuffix = $portVersion
	devel:libwbclient$secondaryArchSuffix = $portVersion
	devel:winbind_krb5_locator$secondaryArchSuffix = $portVersion
	"
REQUIRES_devel="
	samba$secondaryArchSuffix == $portVersion base
	"

BUILD_REQUIRES="
	haiku${secondaryArchSuffix}_devel
	#devel:libcrypto$secondaryArchSuffix
	devel:libexecinfo$secondaryArchSuffix
	devel:libgnutls_openssl$secondaryArchSuffix
	devel:libgpgme$secondaryArchSuffix
	devel:libiconv$secondaryArchSuffix
	devel:libidn$secondaryArchSuffix
	devel:libintl$secondaryArchSuffix
	devel:libldap$secondaryArchSuffix
	devel:libmd$secondaryArchSuffix
	devel:libncurses$secondaryArchSuffix
	devel:libpopt$secondaryArchSuffix
	devel:libreadline$secondaryArchSuffix
	#devel:libssl$secondaryArchSuffix
	devel:libz$secondaryArchSuffix
	devel:libxml2$secondaryArchSuffix
	devel:libexslt$secondaryArchSuffix
	"
BUILD_PREREQUIRES="
	cmd:awk
	cmd:find
	cmd:gcc$secondaryArchSuffix
	cmd:ld$secondaryArchSuffix
	cmd:libtoolize$secondaryArchSuffix
	cmd:make
	cmd:perl
	cmd:pkg_config$secondaryArchSuffix
	cmd:python
	cmd:which
	"

PATCH()
{
	# No other way to disable it.
	sed -i 's/fstack-protector/fstack-protector-disabled/g' buildtools/wafsamba/samba_autoconf.py
}

BUILD()
{
	LDFLAGS="-lnetwork -lbnetapi -lbsd" \
		CFLAGS="-D_BSD_SOURCE" runConfigure ./configure \
		--without-acl-support \
		--with-configdir=$settingsDir/samba \
		--with-privatedir=$settingsDir/samba \
		--localedir=$dataRootDir/locale \
		--with-logfilebase=$sharedStateDir/log

	make $jobArgs
}


INSTALL()
{
	make $jobArgs install

	# copy sample config file
	cp testdata/samba3/smb.conf $settingsDir/samba

	prepareInstalledDevelLibs libdcerpc-binding \
		libdcerpc-samr \
		libdcerpc-server \
		libdcerpc \
		libndr-krb5pac \
		libndr-nbt \
		libndr-standard \
		libndr \
		libnetapi \
		libsamba-credentials \
		libsamba-errors \
		libsamba-hostconfig \
		libsamba-passdb \
		libsamba-policy \
		libsamba-util \
		libsamdb \
		libsmbclient \
		libsmbconf \
		libsmbldap \
		libtevent-util \
		libwbclient \
		winbind_krb5_locator

	packageEntries devel $developDir
}
